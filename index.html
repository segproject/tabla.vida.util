<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Tabla de Vida √ötil Din√°mica</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f7fa;
      color: #333;
      touch-action: manipulation;
    }
    .tabs {
      display: flex;
      background: #2c3e50;
      color: white;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .tab {
      padding: 16px 20px;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s;
      min-width: 180px;
      text-align: center;
      white-space: nowrap;
    }
    .tab:hover {
      background: #34495e;
    }
    .tab.active {
      background: #3498db;
    }
    .tab-content {
      display: none;
      padding: 16px;
    }
    .tab-content.active {
      display: block;
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      font-size: 1.4em;
      margin-top: 0;
    }
    .nota-actualizacion {
      text-align: center;
      font-size: 0.85em;
      color: #666;
      margin-bottom: 15px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
      align-items: flex-end;
    }
    .control-group {
      display: flex;
      flex-direction: column;
      min-width: 150px;
    }
    label {
      font-size: 0.85em;
      margin-bottom: 6px;
      font-weight: bold;
    }
    input, select {
      padding: 12px;
      font-size: 16px;
      border-radius: 6px;
      border: 1px solid #ccc;
      min-height: 44px;
      width: 100%;
      box-sizing: border-box;
    }
    .btn-view {
      background: #607D8B;
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      min-height: 44px;
      width: auto;
      max-width: 140px;
      text-align: center;
      margin-left: 8px;
    }
    .btn-view:hover {
      background: #455A64;
    }
    .btn-view.active {
      background: #3498db;
      font-weight: bold;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-top: 10px;
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    th {
      background-color: #2c3e50;
      color: white;
      font-size: 0.9em;
    }

    /* Colores por categor√≠a */
    .fila-carnicos { background-color: #ffebee; }
    .fila-quesos { background-color: #f3e5f5; }
    .fila-frutas { background-color: #e8f5e9; }
    .fila-salsas { background-color: #fff3e0; }
    .fila-otros { background-color: #e3f2fd; }
    .fila-preps { background-color: #f1f8e9; }
    tr:hover {
      filter: brightness(0.97);
    }

    /* Ocultar columnas seg√∫n vista */
    .col-recibido, .col-preparado, .col-linea {
      display: table-cell;
    }
    .hide-recibido .col-recibido,
    .hide-preparado .col-preparado,
    .hide-linea .col-linea {
      display: none !important;
    }

    /* Examen */
    #seleccionProductos {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 12px;
      background: white;
      margin: 12px 0;
      border-radius: 6px;
    }
    .producto-item {
      margin: 8px 0;
    }
    .producto-item label {
      font-size: 1em;
      cursor: pointer;
      padding: 10px;
      display: block;
      border-radius: 4px;
    }
    .producto-item input[type="checkbox"] {
      width: 24px;
      height: 24px;
      margin-right: 12px;
      vertical-align: middle;
    }
    #tablaExamenManual input {
      width: 100%;
      padding: 12px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 16px;
      min-height: 48px;
      margin-bottom: 8px;
    }
    .emoji {
      font-weight: bold;
      font-size: 1.4em;
      display: inline-block;
      min-width: 28px;
      text-align: center;
      margin-left: 6px;
    }
    .result {
      margin-top: 20px;
      padding: 16px;
      border-radius: 8px;
      background: #fff;
      border: 1px solid #ddd;
      font-size: 0.95em;
    }
    .btn {
      background: #3498db;
      color: white;
      border: none;
      padding: 14px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
      min-height: 52px;
      justify-content: center;
      margin: 8px 0;
      width: 100%;
      max-width: 300px;
      box-sizing: border-box;
    }
    #nuevoExamenBtn {
      background: #9c27b0 !important;
    }
    .correccion {
      margin: 10px 0;
      padding: 12px;
      background: #fff;
      border-left: 4px solid #ff9800;
      border-radius: 6px;
      font-size: 0.95em;
    }
    .correccion.correcta {
      border-left-color: #4caf50;
    }
    .correccion.incorrecta {
      border-left-color: #f44336;
    }

    @media (max-width: 768px) {
      .controls { flex-direction: column; }
      table, thead, tbody, th, td, tr { display: block; }
      td {
        position: relative;
        padding-left: 50%;
        text-align: right;
        padding-top: 14px;
        padding-bottom: 14px;
      }
      td::before {
        content: attr(data-label);
        position: absolute;
        left: 12px;
        width: 45%;
        padding-right: 10px;
        font-weight: bold;
        text-align: left;
        font-size: 0.95em;
      }
      #tablaExamenManual thead { display: none; }
      #tablaExamenManual tr {
        display: block;
        margin-bottom: 24px;
        padding: 16px;
        border: 1px solid #eee;
        border-radius: 8px;
        background: #fafafa;
      }
      #tablaExamenManual td {
        display: flex;
        flex-direction: column;
        padding: 0 !important;
        text-align: left;
      }
      #tablaExamenManual td::before { display: none; }
      #tablaExamenManual td:first-child {
        font-weight: bold;
        margin-bottom: 12px;
        font-size: 1.1em;
      }
      #tablaExamenManual td:not(:first-child) { margin-bottom: 16px; }
    }
  </style>
</head>
<body>

<div class="tabs">
  <div class="tab active" data-tab="tabla">üìä Tabla de Vida √ötil</div>
  <div class="tab" data-tab="examen">üìù Evaluac√≠on</div>
</div>

<div id="tabla" class="tab-content active">
  <h1>Tabla de Vida √ötil de Insumos</h1>
  <p class="nota-actualizacion">√öltima actualizaci√≥n: <strong>12 de agosto de 2025</strong></p>

  <div class="controls">
    <div class="control-group">
      <label for="buscador">Buscar producto</label>
      <input type="text" id="buscador" placeholder="Ej: jalape√±os..." />
    </div>
    <div class="control-group">
      <label for="categoriaFiltro">Categor√≠a</label>
      <select id="categoriaFiltro">
        <option value="">Todas</option>
        <option value="C√ÅRNICOS">C√°rnicos</option>
        <option value="QUESOS">Quesos</option>
        <option value="FRUTAS Y VEGETALES">Frutas y Vegetales</option>
        <option value="SALSAS">Salsas</option>
        <option value="OTROS INSUMOS">Otros Insumos</option>
        <option value="PREPS">Preps</option>
      </select>
    </div>
    <div style="display: flex; align-items: flex-end; gap: 8px; flex-wrap: wrap;">
      <button class="btn-view" id="btnTodas">Todas las etapas</button>
      <button class="btn-view" id="btnRecibido">Recibido</button>
      <button class="btn-view" id="btnPreparado">Preparado</button>
      <button class="btn-view" id="btnLinea">L√≠nea</button>
    </div>
    <div class="control-group" id="filtroEtapaContainer" style="display:none;">
      <label for="filtroEtapaValor">Filtrar por valor</label>
      <select id="filtroEtapaValor">
        <option value="">Todos los valores</option>
      </select>
    </div>
  </div>

  <table id="tablaVidaUtil">
    <thead>
      <tr>
        <th>Categor√≠a</th>
        <th>Producto</th>
        <th class="col-recibido">Recibido</th>
        <th class="col-preparado">Preparado</th>
        <th class="col-linea">L√≠nea</th>
      </tr>
    </thead>
    <tbody id="tablaCuerpo"></tbody>
  </table>
</div>

<div id="examen" class="tab-content">
  <h1>üìù Examen: Selecciona Productos y Rellena</h1>
  <p>Marca los productos que deseas incluir en el examen:</p>
  <div id="seleccionProductos"></div>
  <button class="btn" id="generarExamenManual">Generar Evaluaci√≥n</button>

  <form id="formularioExamenManual" style="display:none;">
    <div style="overflow-x:auto;">
      <table id="tablaExamenManual">
        <thead>
          <tr>
            <th>Producto (Categor√≠a)</th>
            <th>Recibido</th>
            <th>Preparado</th>
            <th>L√≠nea</th>
          </tr>
        </thead>
        <tbody id="cuerpoExamenManual"></tbody>
      </table>
    </div>
    <br>
    <button type="button" class="btn" id="calificarExamenManual">‚úÖ Calificar</button>
    <button type="button" class="btn" id="nuevoExamenBtn" style="display:none;">üîÑ Nuevo Examen</button>
  </form>

  <div id="resultadoExamenManual" class="result" style="display:none;"></div>
</div>

<script>
  // === DATOS EXACTOS DEL EXCEL, NORMALIZADOS ===
  const datosRaw = [
    {cat: "C√ÅRNICOS", prod: "Alitas de pollo - local", recibido: "7", preparado: "7", linea: "1"},
    {cat: "C√ÅRNICOS", prod: "Poppers de pollo", recibido: "7", preparado: "7", linea: "1"},
    {cat: "C√ÅRNICOS", prod: "Pollo asado - importado", recibido: "10", preparado: "7", linea: "1"},
    {cat: "C√ÅRNICOS", prod: "Salchicha italiana", recibido: "12", preparado: "7", linea: "1"},
    {cat: "C√ÅRNICOS", prod: "Chorizo - local", recibido: "7", preparado: "4", linea: "1"},
    {cat: "C√ÅRNICOS", prod: "Chorizo Parrillero", recibido: "Seg√∫n empaque", preparado: "6", linea: "1"},
    {cat: "C√ÅRNICOS", prod: "Carne de res - local", recibido: "12", preparado: "7", linea: "2"},
    {cat: "C√ÅRNICOS", prod: "Salchicha de cerdo", recibido: "12", preparado: "7", linea: "2"},
    {cat: "C√ÅRNICOS", prod: "Tocino", recibido: "30", preparado: "7", linea: "2"},
    {cat: "C√ÅRNICOS", prod: "Pepperoni de cerdo", recibido: "30", preparado: "7", linea: "2"},
    {cat: "C√ÅRNICOS", prod: "Jam√≥n - local", recibido: "14", preparado: "7", linea: "2"},
    
    {cat: "QUESOS", prod: "Queso Mozzarella", recibido: "14", preparado: "7", linea: "1"},
    {cat: "QUESOS", prod: "Queso en tiras", recibido: "14", preparado: "7", linea: "1"},
    {cat: "QUESOS", prod: "Mezcla de 3 quesos (Asiago, Fontina, Provolone)", recibido: "7", preparado: "7", linea: "1"},
    {cat: "QUESOS", prod: "Mezcla de 2 quesos (Romano y Parmesano)", recibido: "7", preparado: "7", linea: "1"},
    
    {cat: "FRUTAS Y VEGETALES", prod: "Champi√±√≥n", recibido: "Seg√∫n empaque", preparado: "1", linea: "11:59 p. m."},
    {cat: "FRUTAS Y VEGETALES", prod: "Cebolla blanca/roja", recibido: "Seg√∫n empaque", preparado: "2", linea: "11:59 p. m."},
    {cat: "FRUTAS Y VEGETALES", prod: "Pimiento rojo", recibido: "Seg√∫n empaque", preparado: "2", linea: "11:59 p. m."},
    {cat: "FRUTAS Y VEGETALES", prod: "Pimiento verde", recibido: "Seg√∫n empaque", preparado: "2", linea: "11:59 p. m."},
    {cat: "FRUTAS Y VEGETALES", prod: "Tomate", recibido: "Seg√∫n empaque", preparado: "2", linea: "11:59 p. m."},
    {cat: "FRUTAS Y VEGETALES", prod: "Jalape√±os", recibido: "Seg√∫n empaque", preparado: "60", linea: "11:59 p. m."},
    {cat: "FRUTAS Y VEGETALES", prod: "Aceituna negra", recibido: "Seg√∫n empaque", preparado: "7", linea: "2"},
    {cat: "FRUTAS Y VEGETALES", prod: "Aceituna verde", recibido: "Seg√∫n empaque", preparado: "7", linea: "2"},
    {cat: "FRUTAS Y VEGETALES", prod: "Pi√±a - lata", recibido: "Seg√∫n empaque", preparado: "15", linea: "2"},
    {cat: "FRUTAS Y VEGETALES", prod: "Pepperoncini", recibido: "Seg√∫n empaque", preparado: "15", linea: "11:59 p. m."},
    
    {cat: "SALSAS", prod: "Salsa pizza - lata", recibido: "Seg√∫n empaque", preparado: "10 horas", linea: "10 horas"},
    {cat: "SALSAS", prod: "Salsa de mayonesa con aj√≠ limo", recibido: "Seg√∫n empaque", preparado: "7", linea: "11:59 p. m."},
    {cat: "SALSAS", prod: "Salsa rosada (1kg)", recibido: "Seg√∫n empaque", preparado: "7", linea: "11:59 p. m."},
    {cat: "SALSAS", prod: "Salsa rosada (0.5 kg)", recibido: "Seg√∫n empaque", preparado: "7", linea: "11:59 p. m."},
    {cat: "SALSAS", prod: "Salsa Parrillera", recibido: "Seg√∫n empaque", preparado: "3", linea: "11:59 p. m."},
    {cat: "SALSAS", prod: "Salsa de ajo (botella - granel)", recibido: "Seg√∫n empaque", preparado: "21", linea: "11:59 p. m."},
    {cat: "SALSAS", prod: "Salsa de mango habanero (bolsa)", recibido: "Seg√∫n empaque", preparado: "7", linea: "11:59 p. m."},
    {cat: "SALSAS", prod: "Salsa Ranch", recibido: "Seg√∫n empaque", preparado: "7", linea: "11:59 p. m."},
    {cat: "SALSAS", prod: "Salsa Bechamel", recibido: "Seg√∫n empaque", preparado: "7", linea: "11:59 p. m."},
    {cat: "SALSAS", prod: "Salsa Chimichurri", recibido: "Seg√∫n empaque", preparado: "15", linea: "2"},
    {cat: "SALSAS", prod: "Salsa de ajo (blister - cup)", recibido: "Seg√∫n empaque", preparado: "Seg√∫n empaque", linea: "11:59 p. m."},
    {cat: "SALSAS", prod: "Salsa Parmesana (botella - granel)", recibido: "Seg√∫n empaque", preparado: "21", linea: "11:59 p. m."},
    {cat: "SALSAS", prod: "Salsa BBQ (blister - cup)", recibido: "Seg√∫n empaque", preparado: "Seg√∫n empaque", linea: "Seg√∫n empaque"},
    {cat: "SALSAS", prod: "Salsa BBQ (bolsa)", recibido: "Seg√∫n empaque", preparado: "4", linea: "2"},
    {cat: "SALSAS", prod: "Salsa Buffalo (blister - cup)", recibido: "Seg√∫n empaque", preparado: "Seg√∫n empaque", linea: "Seg√∫n empaque"},
    {cat: "SALSAS", prod: "Salsa de Miel Picante", recibido: "Seg√∫n empaque", preparado: "7", linea: "11:59 p. m."},
    
    {cat: "OTROS INSUMOS", prod: "Dustinator", recibido: "Seg√∫n empaque", preparado: "14", linea: "2"},
    {cat: "OTROS INSUMOS", prod: "Masa Croisant", recibido: "5", preparado: "", linea: "11:59 p. m."},
    {cat: "OTROS INSUMOS", prod: "Masa delgada - importada", recibido: "30", preparado: "3", linea: ""},
    {cat: "OTROS INSUMOS", prod: "Az√∫car glaseada (Icing) - local", recibido: "Seg√∫n empaque", preparado: "30", linea: "2"},
    {cat: "OTROS INSUMOS", prod: "Cinamon Spreed", recibido: "Seg√∫n empaque", preparado: "30", linea: "2"},
    {cat: "OTROS INSUMOS", prod: "Or√©gano - sachet", recibido: "Seg√∫n empaque", preparado: "Seg√∫n empaque", linea: "Seg√∫n empaque"},
    {cat: "OTROS INSUMOS", prod: "Aji panca - sachet", recibido: "Seg√∫n empaque", preparado: "Seg√∫n empaque", linea: "Seg√∫n empaque"},
    {cat: "OTROS INSUMOS", prod: "Or√©gano - granel", recibido: "Seg√∫n empaque", preparado: "Seg√∫n empaque", linea: "Seg√∫n empaque"},
    {cat: "OTROS INSUMOS", prod: "Aji panca - granel", recibido: "Seg√∫n empaque", preparado: "Seg√∫n empaque", linea: "Seg√∫n empaque"},
    {cat: "OTROS INSUMOS", prod: "Sazonador italiano", recibido: "Seg√∫n empaque", preparado: "7", linea: "3"},
    {cat: "OTROS INSUMOS", prod: "Pasta de lasagna", recibido: "10", preparado: "8", linea: ""},
    {cat: "OTROS INSUMOS", prod: "Tortilla", recibido: "Seg√∫n empaque", preparado: "7", linea: "11:59 p. m."},
    {cat: "OTROS INSUMOS", prod: "Manjar Blanco", recibido: "Seg√∫n empaque", preparado: "15", linea: "5"},
    {cat: "OTROS INSUMOS", prod: "Az√∫car Impalpable", recibido: "Seg√∫n empaque", preparado: "30", linea: "5"},
    
    {cat: "PREPS", prod: "Lasagna (All the meats/The Works/Americana)", recibido: "", preparado: "4", linea: ""},
    {cat: "PREPS", prod: "Rollitos de Pepperoni/Jam√≥n", recibido: "", preparado: "6 horas", linea: "6 horas"},
    {cat: "PREPS", prod: "Rollitos de Manjar", recibido: "", preparado: "6 horas", linea: "6 horas"},
    {cat: "PREPS", prod: "Rollitos de Canela", recibido: "", preparado: "6 horas", linea: "6 horas"}
  ];

  // Normalizar datos: eliminar espacios extra
  const datos = datosRaw.map(item => ({
    cat: item.cat.trim(),
    prod: item.prod.trim(),
    recibido: item.recibido ? item.recibido.trim() : "",
    preparado: item.preparado ? item.preparado.trim() : "",
    linea: item.linea ? item.linea.trim() : ""
  }));

  // === Resto del c√≥digo igual, pero con eventos corregidos ===
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      tab.classList.add('active');
      document.getElementById(tab.dataset.tab).classList.add('active');
    });
  });

  const clasePorCategoria = {
    "C√ÅRNICOS": "fila-carnicos",
    "QUESOS": "fila-quesos",
    "FRUTAS Y VEGETALES": "fila-frutas",
    "SALSAS": "fila-salsas",
    "OTROS INSUMOS": "fila-otros",
    "PREPS": "fila-preps"
  };

  let etapaActiva = "todas";

  function renderTabla(data) {
    const cuerpo = document.getElementById("tablaCuerpo");
    cuerpo.innerHTML = "";
    if (data.length === 0) {
      cuerpo.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#888;">No se encontraron resultados.</td></tr>`;
      return;
    }
    data.forEach(item => {
      const clase = clasePorCategoria[item.cat] || "";
      const fila = document.createElement("tr");
      fila.className = clase;
      fila.innerHTML = `
        <td data-label="Categor√≠a">${item.cat}</td>
        <td data-label="Producto">${item.prod}</td>
        <td class="col-recibido" data-label="Recibido">${item.recibido || "‚Äì"}</td>
        <td class="col-preparado" data-label="Preparado">${item.preparado || "‚Äì"}</td>
        <td class="col-linea" data-label="L√≠nea">${item.linea || "‚Äì"}</td>
      `;
      cuerpo.appendChild(fila);
    });
  }

  function aplicarVista(vista) {
    etapaActiva = vista;
    const tabla = document.getElementById("tablaVidaUtil");
    tabla.classList.remove("hide-recibido", "hide-preparado", "hide-linea");
    const container = document.getElementById("filtroEtapaContainer");
    
    if (vista === "todas") {
      container.style.display = "none";
    } else {
      container.style.display = "flex";
      construirFiltroEtapa(vista);
    }

    if (vista === "recibido") {
      tabla.classList.add("hide-preparado", "hide-linea");
    } else if (vista === "preparado") {
      tabla.classList.add("hide-recibido", "hide-linea");
    } else if (vista === "linea") {
      tabla.classList.add("hide-recibido", "hide-preparado");
    }
  }

  function ordenarValores(valores) {
    const numericos = [];
    const horas = [];
    const texto = [];

    valores.forEach(val => {
      if (/^\d+$/.test(val)) {
        numericos.push(parseInt(val));
      } else if (val.includes("hora")) {
        horas.push(val);
      } else {
        texto.push(val);
      }
    });

    numericos.sort((a, b) => a - b);
    horas.sort();
    texto.sort();

    return [...numericos.map(String), ...horas, ...texto];
  }

  // === FUNCI√ìN ACTUALIZADA: respeta categor√≠a y b√∫squeda ===
  function construirFiltroEtapa(campo) {
    const select = document.getElementById("filtroEtapaValor");
    select.innerHTML = '<option value="">Todos los valores</option>';

    const texto = document.getElementById("buscador").value.toLowerCase().trim();
    const cat = document.getElementById("categoriaFiltro").value;

    const filtrados = datos.filter(item => {
      const coincideBusqueda = !texto || item.prod.toLowerCase().includes(texto);
      const coincideCat = !cat || item.cat === cat;
      return coincideBusqueda && coincideCat;
    });

    const valores = new Set();
    filtrados.forEach(item => {
      const val = item[campo] || "";
      if (val !== "") valores.add(val);
    });

    const valoresOrdenados = ordenarValores(Array.from(valores));
    valoresOrdenados.forEach(val => {
      const opt = document.createElement("option");
      opt.value = val;
      opt.textContent = val;
      select.appendChild(opt);
    });
  }

  function filtrarTabla() {
    const texto = document.getElementById("buscador").value.toLowerCase().trim();
    const cat = document.getElementById("categoriaFiltro").value;
    const valorEtapa = document.getElementById("filtroEtapaValor").value;

    const filtrados = datos.filter(item => {
      const coincideBusqueda = !texto || item.prod.toLowerCase().includes(texto);
      const coincideCat = !cat || item.cat === cat;
      let coincideEtapa = true;
      if (etapaActiva !== "todas" && valorEtapa) {
        coincideEtapa = (item[etapaActiva] || "") === valorEtapa;
      }
      return coincideBusqueda && coincideCat && coincideEtapa;
    });

    renderTabla(filtrados);
  }

  // === EVENTOS ACTUALIZADOS ===
  document.getElementById("buscador").addEventListener("input", () => {
    filtrarTabla();
    if (etapaActiva !== "todas") {
      construirFiltroEtapa(etapaActiva);
    }
  });

  document.getElementById("categoriaFiltro").addEventListener("change", () => {
    filtrarTabla();
    if (etapaActiva !== "todas") {
      construirFiltroEtapa(etapaActiva);
    }
  });

  document.getElementById("filtroEtapaValor").addEventListener("change", filtrarTabla);

  function crearHandlerVista(vista) {
    return () => {
      document.querySelectorAll(".btn-view").forEach(btn => btn.classList.remove("active"));
      document.getElementById(`btn${vista.charAt(0).toUpperCase() + vista.slice(1)}`).classList.add("active");
      aplicarVista(vista);
      filtrarTabla();
    };
  }

  document.getElementById("btnTodas").addEventListener("click", crearHandlerVista("todas"));
  document.getElementById("btnRecibido").addEventListener("click", crearHandlerVista("recibido"));
  document.getElementById("btnPreparado").addEventListener("click", crearHandlerVista("preparado"));
  document.getElementById("btnLinea").addEventListener("click", crearHandlerVista("linea"));

  renderTabla(datos);
  document.getElementById("btnTodas").click();

  // === EXAMEN ===
  function cargarListaSeleccion() {
    const cont = document.getElementById("seleccionProductos");
    cont.innerHTML = "";
    datos.forEach((item, i) => {
      const div = document.createElement("div");
      div.className = "producto-item";
      div.innerHTML = `
        <label>
          <input type="checkbox" data-index="${i}"> 
          ${item.prod} <small>(${item.cat})</small>
        </label>
      `;
      cont.appendChild(div);
    });
  }

  function reiniciarExamen() {
    document.getElementById("formularioExamenManual").style.display = "none";
    document.getElementById("resultadoExamenManual").style.display = "none";
    document.querySelectorAll("#seleccionProductos input[type='checkbox']").forEach(chk => chk.checked = false);
    setTimeout(cargarListaSeleccion, 100);
    document.getElementById("nuevoExamenBtn").style.display = "none";
  }

  document.getElementById("nuevoExamenBtn").addEventListener("click", reiniciarExamen);

  document.getElementById("generarExamenManual").addEventListener("click", () => {
    const checks = document.querySelectorAll("#seleccionProductos input[type='checkbox']:checked");
    if (checks.length === 0) {
      alert("Por favor, selecciona al menos un producto.");
      return;
    }
    const seleccionados = Array.from(checks).map(chk => datos[parseInt(chk.dataset.index)]);
    let html = "";
    seleccionados.forEach((item, i) => {
      html += `
        <tr>
          <td><strong>${item.prod}</strong><br><small>${item.cat}</small></td>
          <td><input type="text" name="recibido_${i}" data-real="${item.recibido}" placeholder="Ej: 7"><span class="emoji" id="emoji_r_${i}"></span></td>
          <td><input type="text" name="preparado_${i}" data-real="${item.preparado}" placeholder="Ej: 7"><span class="emoji" id="emoji_p_${i}"></span></td>
          <td><input type="text" name="linea_${i}" data-real="${item.linea}" placeholder="Ej: 1 o 11:59 p. m."><span class="emoji" id="emoji_l_${i}"></span></td>
        </tr>
      `;
    });
    document.getElementById("cuerpoExamenManual").innerHTML = html;
    document.getElementById("formularioExamenManual").style.display = "block";
    document.getElementById("resultadoExamenManual").style.display = "none";
    document.getElementById("nuevoExamenBtn").style.display = "block";
  });

  // --- FUNCIONES DE NORMALIZACI√ìN Y COMPARACI√ìN CORREGIDAS ---

  function normalizarTexto(texto) {
    if (!texto) return "";
    return texto
      .toLowerCase()
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "")
      .replace(/\s+/g, " ")
      .trim();
  }

  function normalizarHora(texto) {
    if (!texto) return "";
    let t = texto.toLowerCase().trim();
    t = t
      .replace(/\s*\.\s*/g, "")   // elimina puntos con espacios: "p. m." ‚Üí "pm"
      .replace(/\s+/g, "")        // elimina todos los espacios: "11:59 pm" ‚Üí "11:59pm"
      .trim();
    return t;
  }

  function respuestasEquivalentes(user, real) {
    if (user === "" && real === "") return true;
    if (user === "" || real === "") return false;

    const userNorm = normalizarTexto(user);
    const realNorm = normalizarTexto(real);

    // Caso especial: si la respuesta correcta es una variante de "11:59 p. m."
    if (real.includes("11:59") && 
        (real.toLowerCase().includes("p.") || 
         real.toLowerCase().includes("pm") || 
         real.toLowerCase().includes("p m"))) {

      const userHora = normalizarHora(user);
      const realHora = normalizarHora(real);
      return userHora === realHora;
    }

    // Caso especial: "segun empaque"
    if (realNorm === "segun empaque") {
      return userNorm === "segun empaque";
    }

    // Comparaci√≥n normalizada est√°ndar
    return userNorm === realNorm;
  }

  document.getElementById("calificarExamenManual").addEventListener("click", () => {
    const inputs = document.querySelectorAll("#cuerpoExamenManual input");
    let total = 0, correctos = 0, errores = [];
    inputs.forEach(input => {
      const user = input.value.trim();
      const real = input.dataset.real || "";
      total++;
      const esCorrecto = respuestasEquivalentes(user, real);
      const emojiSpan = input.nextElementSibling;
      if (esCorrecto) {
        correctos++;
        emojiSpan.textContent = "‚úÖ";
        emojiSpan.className = "emoji correcto";
      } else {
        emojiSpan.textContent = "‚ùå";
        emojiSpan.className = "emoji incorrecto";
        const row = input.closest("tr");
        const producto = row.querySelector("strong").textContent;
        const cat = row.querySelector("small").textContent;
        const colIndex = input.closest("td").cellIndex;
        const colName = colIndex === 1 ? "Recibido" : colIndex === 2 ? "Preparado" : "L√≠nea";
        errores.push({ producto, cat, colName, user, real });
      }
    });
    const resDiv = document.getElementById("resultadoExamenManual");
    let msg = `<h3>Resultado del examen</h3><p><strong>${correctos}</strong> de <strong>${total}</strong> celdas correctas.</p>`;
    if (errores.length > 0) {
      msg += `<h4>Correcciones detalladas:</h4>`;
      errores.forEach(e => {
        msg += `<div class="correccion incorrecta"><strong>${e.producto}</strong> (${e.cat}) - ${e.colName}: <span style="color:#888">Respondiste: "${e.user || '(vac√≠o)'}"</span> ‚Üí <span style="color:#f44336">Correcto: "${e.real || '(vac√≠o)'}"</span></div>`;
      });
    } else {
      msg += `<div class="correccion correcta">¬°Excelente! Todas tus respuestas son correctas.</div>`;
    }
    resDiv.innerHTML = msg;
    resDiv.style.display = "block";
  });

  document.querySelector('.tab[data-tab="examen"]').addEventListener('click', () => {
    setTimeout(cargarListaSeleccion, 100);
  });
  if (document.getElementById("examen").classList.contains("active")) {
    cargarListaSeleccion();
  }
</script>

</body>
</html>
